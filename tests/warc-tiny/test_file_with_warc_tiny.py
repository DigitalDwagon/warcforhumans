import sys
from pathlib import Path

import pytest
import requests
import importlib.util


def test_file_with_warc_tiny(tmp_path, warc_writer, fake_http_server):
    requests.get(fake_http_server(b"HTTP/1.1 200 OK\r\nContent-Length: 13\r\n\r\nHello, world!\r\n\r\n"))
    # Real requests captured with Wireshark:
    # A gif from textfiles.com
    requests.get(fake_http_server(b"HTTP/1.1 200 OK\r\nDate: Tue, 02 Dec 2025 15:19:07 GMT\r\nServer: Apache/2.4.58 (FreeBSD) OpenSSL/1.1.1o-freebsd\r\nLast-Modified: Sun, 01 Aug 1999 17:03:50 GMT\r\nETag: \"3bd-35109b302e980\"\r\nAccept-Ranges: bytes\r\nContent-Length: 957\r\nKeep-Alive: timeout=5, max=98\r\nConnection: Keep-Alive\r\nContent-Type: image/gif\r\n\r\nGIF89a\333\000\034\000\304\000\000\377\377\377\\\377FV\357BP\337=K\3179E\2774?\25709\237,4\217'.\200#(p\037#`\032\035P\026\027@\022\0210\r\f \t\006\020\004\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000,\000\000\000\000\333\000\034\000@\005\377`$\216di\236h\252\256l\353\276p,\317tMBI\262\330|\357\227\214\334\343Wz(r\f\bi\261\003\346\022Cb\r\022\b\030\"\212*CT(\220\002\211\310\"\240h\230\317\321H\3274 \234\337+G\3400\242\206G\353R\373}v\201M\r\001\r#\t\001\"{|\203-\177(\205(\201\212\"\a\002\f\211J\nM\020\r\004\002EiR\240\241\242\243\244\245\246\247\250\251\252\253,\005\235ct\a\206j\002UU\004#\016\004\266\001\003\016\"\205\275\005\266\270\021\301\266\b-\006\274\001\004J\306U\003\303\267\300\314\311\255\314U\"\201\265\266[\325\274\327+\331\214\021\274\217\202@\335U\005\317\020\273\274W\333u\322\254\366\367\370\371\372\373\374\375\376\377\000\003\n4\361`\230\200\002a\030\024\030\320L\241\227\201\247\312\215\200\024J\200\001%\016\024\374jA\261G \002\b\022\f\213\324\"\v\254\000c\344\377\345\021\361gL\2313&\361\fx6\002\321\031\002\0038\"\350\262\354\016\227\231z\334\274\301\351\307\347\304t\325\016\t\275\231s\221\321\022\216Nt\224D\351\215\254!c\016\"P\240\261\204\301o0\026\216\220%\242['9U\256@\220\025\357\327:[\nF0`hk\300\323\023\v\314\216\t\320\351m\225\270\"\346\362\262\353\"o\335\004Y\376FXV\345\227\340\303q\310md\314\354Wbf\200\035L\253\"\340\200\222\003t\331m\004\a\261\264\351\323\250S\253^\315\272\265\353\327\260c\313\236M\273\266\355\3335\nvA\030\301a\001x\017q\273\030\320d\004c\222?\366\332\222\307%\270q[\310k,`L\000\354\360\207\r\224\024\032\322\345\001\022\023A\022X\327\324\340W\003\035$\214 \376\024g\301\367:f\314\243\037\241^\001\373\024\232\346\240\331&\310\275\375\"G\374\327\202\003\201\034p\006M\004\232\201N\377t\020\270\227\300hr!\341\3003\201\2146\000s-8b\020\004y\fs\300\020\f\240\024\001\004\002P\022\230\000Mi\262\213\000\n@\240@2\205|\030\301\003\262\024\227\202\003\t(\022\b`*\362\325\342\213\320\310H\243\210+\344g\240\031Qp\263\005\207M\3058\304\2206\242@\240~f \330\000YR!\305\037\001\277\2708G5\3370pP\t.2\024\345\n\201\f\363\2004\214\254dN\030\3070\343\223\233,\2213\213\n\205\034\264\220Dt\232cgQ\200h\031\225\235w\216s\027!\205\2220\225\032v*\222\000<UDi\200s0h1b\025\203(0\300\000q\341\020@\001[p\222c\003\n,\263\303\021\233>\261Q\210\2406\300\000\002\233Ff\200\253\b\324R@\\\250\332\225\303\252\237V\362j\254-\b \224\00289 \313\001\216\r\223\000\004\254\372\nkS\370\345\360\351\023\317\204\247lB\016\030\345p\354\2563\242\270\200\031\217\006\300\235\000\b\230\261\000Q\212\336w\ny\020\016X%\f\n\312\220 M/\274\373\302\274\373<\200\244\t\344\251\333\200\272\302\005,\360\300\004\027l\360\301\b'\354Z\b\000;"))
    # textfiles.com/
    requests.get(fake_http_server(b"HTTP/1.1 200 OK\r\nDate: Tue, 02 Dec 2025 15:19:06 GMT\r\nServer: Apache/2.4.58 (FreeBSD) OpenSSL/1.1.1o-freebsd\r\nLast-Modified: Sun, 03 Nov 2024 02:54:33 GMT\r\nETag: \"2958-625f949a948e2\"\r\nAccept-Ranges: bytes\r\nContent-Length: 10584\r\nKeep-Alive: timeout=5, max=100\r\nConnection: Keep-Alive\r\nContent-Type: text/html\r\n\r\n" + b"<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 3.2 Final//EN\">\n<HTML><TITLE>T E X T F I L E S D O T C O M</TITLE> \n\n<!-- TEXTFILES.COM is a site dedicated to the Textfiles of the BBS World -->\n<!-- from the 1980's. Naturally, this role expands into the continuation -->\n<!-- of the textfile-writing world into the 1990's, and goes back to the -->\n<!-- 1960's and 1970's as well. If you have any questions, feel free to  -->\n<!-- mail them to jason@textfiles.com. Submissions are always wanted.    -->\n\n<!-- Unlike a lot of sites, this Page Source has a lot of comments. This -->\n<!-- is because this site's main purpose is education, and a user should -->\n<!-- have the opportunity to see how this site was created and what the  -->\n<!-- thought process was behind the look. Plus, the site weighs in at a  -->\n<!-- very low size, so giving an explanation with the download is not a  -->\n<!-- very bandwidth-intensive activity, and might inspire someone.       -->\n\n<!-- Since TEXTFILES.COM harkens back to an earlier era, but is being done  -->\n<!-- in the modern era, it is the usual blend of recent features and hacks  -->\n<!-- to simulate older technology. In this case, everything is in green     -->\n<!-- (which, believe it or not, is the light that the eye takes the longest -->\n<!-- to get tired looking at) on a black screen, and the visual \"hook\" is   -->\n<!-- the Blinking Cursor, which has disappeared in a lot of mainstream,     -->\n<!-- windowed applications. This is accomplished with small animated GIFs.  -->\n\n<!-- Now, let's make the page the usual black background and green text. -->\n\n<BODY BGCOLOR=\"#000000\" TEXT=\"00FF00\" LINK=\"00FF00\" ALINK=\"#00FF00\" VLINK=\"#00FF00\">\n\n<!-- Where possible, use the courier font, which looks like old-style\n     typewriter faces. Make sure that this color will be green too.      -->\n\n<CENTER>\n\n<TABLE WIDTH=\"100%\">\n<TR><TD ALIGN=CENTER BGCOLOR=\"#004400\">\n    <B><CENTER><FONT FACE=\"Courier New,Courier\" COLOR=\"#00FF00\">\n    TEXTFILES.COM Mirror Sites: </B></A><BR>\n\n   <A HREF=\"http://www.textfiles.com/index.html\" \n      TITLE=\"TEXTFILES.COM Parent Mirror, US\">US</A>\n   <A HREF=\"https://mirror2.evolution-host.com/textfiles/\"\n      TITLE=\"Evolution Host, Canada\">.CA</a>\n   <A HREF=\"https://mirror.cyberbits.eu/textfiles.com/\"\n      TITLE=\"Cyberbits, Paris, France\">.EU</A>\n   <A HREF=\"http://textfiles.meulie.net\" \n      TITLE=\"Evert Meulie, Germany\">.DE</A>\n   <A HREF=\"http://textfiles.serverrack.net/\" \n      TITLE=\"SERVERRACK.NET, Fairfax, VA\">US-VA</A>\n   <A HREF=\"http://textfiles.vistech.net/\"\n      TITLE=\"Vistech, Talahassee, FL\">US-FL</A>\n   <A HREF=\"http://mirror3.preterhuman.net/textfiles\"\n      TITLE=\"Preterhuman, BC, CANADA\">BC-CA</A>\n\n   </CENTER></TD></TR>\n</TABLE>\n<TABLE>\n<TR><TD ALIGN=MIDDLE><FONT FACE=\"Courier New,Courier\" COLOR=\"#00FF00\" size=+2>If you enjoy textfiles.com, tweet about it with hashtag #textfiles.<br>\n</TABLE>\n\n<TABLE HEIGHT=80%>\n<TR><TD ALIGN=MIDDLE>\n<CENTER>\n<IMG ALT=\"T E X T F I L E S\"\n WIDTH=391 HEIGHT=68 SRC=\"images/textfile.gif\">\n\n<TABLE WIDTH=620>\n<TR><TD VALIGN=CENTER>\n\n<!-- Make this entire description bright green letters, much like the -->\n<!-- logo, and use a \"Courier\" font, which will give the letters more -->\n<!-- of a \"typewriter\" look, again for a sort of nostalgia feel.      -->\n\n<FONT FACE=\"Courier New,Courier\" COLOR=\"#00FF00\">\n\n    On the face of things, we seem to be merely talking about text-based files, \n    containing only the letters of the English Alphabet (and the occasional\n    punctuation mark).\n   \n    <P>\n\n    On deeper inspection, of course, this isn't quite the case. What this site\n    offers is a glimpse into the history of writers and artists bound by the\n    128 characters that the American Standard Code for Information Interchange\n    (ASCII) allowed them. The focus is on mid-1980's textfiles and the world\n    as it was then, but even these files are sometime retooled 1960s and 1970s\n    works, and offshoots of this culture exist to this day.\n \n</FONT>\n</TD></TR>\n</TABLE>\n\n<!-- Having completed the quick blurb introduction, give the user -->\n<!-- five choices. Essentially, WHO, WHAT, WHERE, WHY, and HOW.   -->\n\n<P>\n\n<!-- These five choices are presented in their own table, which has a   -->\n<!-- WIDTH tag set slightly larger than the table above. This is in     -->\n<!-- truth a somewhat meaningless width, since all three items are GIFs -->\n<!-- and are only on one line, so how wide it is is How Wide It Is. The -->\n<!-- tag is mostly added for completeness, and potentially to help the  -->\n<!-- browser to render.                                                 -->\n\n<TABLE WIDTH=640>\n<TR><TD ALIGN=CENTER>\n\n<!-- \"Where are the Files?\" will take the user to the file directory. -->\n\n<!-- When designing a site, it is very important to know what it is your -->\n<!-- intended audience is going to want and to give it to them. All the  -->\n<!-- work you put into providing a nice-looking page will be meaningless -->\n<!-- if the users are feeling they are \"wading through\" your work to get -->\n<!-- to whatever it is they specifically want. To this end, the main     -->\n<!-- \"point\" of this site is to give users textfiles, so the archives    -->\n<!-- are the first selection.                                            -->\n\n<A HREF=\"directory.html\">\n<IMG WIDTH=219 HEIGHT=28 ALT=\"&nbsp    Where are the Files?    &nbsp\" \n     SRC=\"images/wheref.gif\" BORDER=0></A>\n\n<TD ALIGN=CENTER>\n\n<!-- \"Who are You?\" answers the question of who runs the site. -->\n\n<!-- Often, people like to know what person or persons are behind the site -->\n<!-- they are browsing, to see if they can pick up biases, or, if the site -->\n<!-- is interesting, to learn more about the person who made the site, as  -->\n<!-- they too might be interesting. I have taken advantage of that to put  -->\n<!-- all of my historical perspectives, site news, and personal writing    -->\n<!-- on a page about myself, separate from the rest of the file pages.     -->\n<!-- This also means that the people who are reading stuff about me will   -->\n<!-- be people who have shown, by clicking the middle selection, that they -->\n<!-- like to get a \"big picture view\" of everything. Or that they're nosy. -->\n<!-- Or that they click on things randomly. I will accept all three.       -->\n\n<A HREF=\"jason\">\n<IMG WIDTH=139 HEIGHT=28 ALT=\"&nbsp     Who are You?     &nbsp\"\n     SRC=\"images/whoyou.gif\" BORDER=0></A>\n\n<TD ALIGN=CENTER>\n\n<!-- \"Why Are You Doing This?\" shows my motivations and site information. -->\n\n<!-- I phrased all three of the selections for TEXTFILES.COM in the form of -->\n<!-- questions, to put the reader/browser into an inquisitve mood, to ask   -->\n<!-- why things are, where things came from, who is behind the curtain. In  -->\n<!-- this last page, I provide myself a forum to give a \"statement\" as to   -->\n<!-- why I've dumped weeks of time into this project. I believe it, too.    -->\n\n<A HREF=\"statement.html\">\n<IMG WIDTH=228 HEIGHT=28 ALT=\"&nbsp    Why does this Matter?   &nbsp\"\n     SRC=\"images/wmatter.gif\" BORDER=0></A>\n\n<TR><TD ALIGN=CENTER>\n\n<!-- \"What was it Like?\" will be the part that gives you tours and the -->\n<!-- perspective of all the fine folks who were a part of this world.  -->\n\n<A HREF=\"history\">\n<IMG HEIGHT=28 WIDTH=191 ALT=\"&nbsp       What was it Like?              &nbsp\"\n     SRC=\"images/whatw.gif\" BORDER=0></A>\n\n<TD>\n<TD ALIGN=CENTER>\n<A HREF=\"support\">\n<IMG HEIGHT=28 WIDTH=176 ALT=\"&nbsp      How can I Help?    &nbsp\"\n     SRC=\"images/howc.gif\" BORDER=0></A>\n\n</TR></TD>\n</TABLE>\n</TABLE>\n</TABLE>\n\n<TABLE WIDTH=100%>\n<TR><TD ALIGN=CENTER BGCOLOR=\"#004400\">\n    <CENTER>\n    <B><FONT FACE=\"Courier New,Courier\" COLOR=\"#00FF00\">\n    TEXTFILES.COM Sites</B></A><BR>\n\n    <A style=\"text-decoration: none\"\n    HREF=\"http://ascii.textfiles.com\" \n    TITLE=\"Jason Scott's Weblog\">\n    <FONT FACE=\"Courier New,Courier\">ASCII</B></A>\n\n    <A style=\"text-decoration: none\"\n    HREF=\"http://www.bbsdocumentary.com\" \n    TITLE=\"Jason Scott's BBS Documentary!\">\n    <FONT FACE=\"Courier New,Courier\">BBSDOCUMENTARY</B></A>\n\n    <A style=\"text-decoration: none\"\n    HREF=\"http://artscene.textfiles.com\" \n    TITLE=\"ARTSCENE.TEXTFILES.COM: Decades of Computer Art and Expression\">\n    <FONT FACE=\"Courier New,Courier\">ARTSCENE</B></A>\n\n    <A style=\"text-decoration: none\"\n    HREF=\"http://www.bbshistory.org\"\n    TITLE=\"BBSHISTORY.ORG: Jason's Collections of Online History\">\n    <FONT FACE=\"Courier New,Courier\">BBSHISTORY</B></A>\n\n    <A style=\"text-decoration: none\"\n    HREF=\"http://cd.textfiles.com\"\n    TITLE=\"CD.TEXTFILES.COM: Dozens of old Shareware CDs\">\n    <FONT FACE=\"Courier New,Courier\">CD</B></A>\n\n    <A style=\"text-decoration: none\"\n    HREF=\"http://discmaster.textfiles.com\"\n    TITLE=\"DISCMASTER.TEXTFILES.COM: The Search Engine for CD-ROMs\">\n    <FONT FACE=\"Courier New,Courier\"><blink>DISCMASTER</bling></B></A>\n\n    <A style=\"text-decoration: none\"\n    HREF=\"http://digest.textfiles.com\" \n    TITLE=\"DIGEST.TEXTFILES.COM: The Mailing Lists That Made a Difference\">\n    <FONT FACE=\"Courier New,Courier\">DIGEST</B></A>\n\n    <A style=\"text-decoration: none\"\n    HREF=\"http://web.textfiles.com\" \n    TITLE=\"WEB.TEXTFILES.COM: Textfiles That Have Come After 1995\">\n    <FONT FACE=\"Courier New,Courier\">WEB</B></A>\n\n    <A style=\"text-decoration: none\"\n    HREF=\"http://bbslist.textfiles.com\" \n    TITLE=\"BBSLIST.TEXTFILES.COM: All the BBSes there Ever Were\">\n    <FONT FACE=\"Courier New,Courier\">BBSLIST</B></A>\n\n    <A style=\"text-decoration: none\"\n    HREF=\"http://timeline.textfiles.com\" \n    TITLE=\"TIMELINE.TEXTFILES.COM: BBS-Related Events\">\n    <FONT FACE=\"Courier New,Courier\">TIMELINE</B></A>\n\n    <A style=\"text-decoration: none\"\n    HREF=\"http://pdf.textfiles.com\" \n    TITLE=\"PDF.TEXTFILES.COM: Your Eclectic PDF Collection\">\n    <FONT FACE=\"Courier New,Courier\">PDF</B></A>\n\n    <A style=\"text-decoration: none\"\n    HREF=\"http://audio.textfiles.com\" \n    TITLE=\"AUDIO.TEXTFILES.COM: The Sound of Online\">\n    <FONT FACE=\"Courier New,Courier\">AUDIO</B></A>\n\n</CENTER>\n</TABLE>\n<P>\n<CENTER>\n<FONT FACE=\"Courier New,Courier\">\nTEXTFILES.COM has been online for nearly 25 years with no ads or clickthroughs.<br>\nIf you feel like donating to its roughly $1200 yearly upkeep: <a href=\"https://paypal.me/textfiles\">Paypal</a> or <a href=\"https://account.venmo.com/u/textfiles\">Venmo</a>.<br>\n(If you prefer a different method, you can always <a href=\"mailto:jason@textfiles.com\">contact Jason</a>.)\n</FONT>\n</CENTER>\n\n<!-- End this document and indicate that the page is over -->\n\n</FONT>\n</BODY>\n</HTML>\n"))
    warc_writer.close()
    path = (tmp_path / "test.warc")

    warc_tiny_path = Path(__file__).parent / "warc-tiny.py"
    spec = importlib.util.spec_from_file_location("warc_tiny", warc_tiny_path)
    warc_tiny = importlib.util.module_from_spec(spec)
    sys.modules["warc_tiny"] = warc_tiny
    spec.loader.exec_module(warc_tiny)

    processor = warc_tiny.VerifyMode()
    processor.process_event(warc_tiny.NewFile(str(path)))
    for event in warc_tiny.iter_warc(str(path)):
        processor.process_event(event)
    processor.process_event(warc_tiny.EndOfFile(str(path)))